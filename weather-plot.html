<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Data</title>

  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .controls {
      margin: 1rem 0;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    button {
      padding: 0.4rem 0.8rem;
      cursor: pointer;
    }
    canvas {
      max-width: 100%;
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>

<h1>Weather Data</h1>

<div class="controls">
  <button id="dayBtn">Last Day</button>
  <button id="weekBtn">Last Week</button>

  <button id="cBtn">째C</button>
  <button id="fBtn">째F</button>
</div>

<canvas id="tempChart"></canvas>
<canvas id="pressureChart"></canvas>
<canvas id="humidityChart"></canvas>

<script>

const DATA_URLS = {
  day:  "https://raw.githubusercontent.com/mr-hazmat/RPi_Compact-Weather-Station/main/docs/data/weather_last_day.csv",
  week: "https://raw.githubusercontent.com/mr-hazmat/RPi_Compact-Weather-Station/main/docs/data/weather_last_week.csv"
};

let currentRange = "day";   // day | week
let currentUnit  = "c";     // c | f

let charts = {};

async function loadCSV(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error("Failed to load CSV");

  const text = await response.text();
  const lines = text.trim().split("\n");
  const headers = lines.shift().split(",");

  return lines.map(line => {
    const values = line.split(",");
    return Object.fromEntries(headers.map((h, i) => [h, values[i]]));
  });
}

function createLineChart(ctx, label, data, color) {
  return new Chart(ctx, {
    type: "line",
    data: {
      labels: data.labels,
      datasets: [{
        label,
        data: data.values,
        borderColor: color,
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { ticks: { maxTicksLimit: 10 } }
      }
    }
  });
}

function destroyCharts() {
  Object.values(charts).forEach(chart => chart.destroy());
  charts = {};
}

async function render() {
  destroyCharts();

  const rows = await loadCSV(DATA_URLS[currentRange]);

  const labels = rows.map(r => r.timestamp.replace("T", " "));

  const tempField = currentUnit === "c" ? "temp_c" : "temp_f";
  const tempLabel = currentUnit === "c" ? "Temperature (째C)" : "Temperature (째F)";

  charts.temp = createLineChart(
    document.getElementById("tempChart"),
    tempLabel,
    {
      labels,
      values: rows.map(r => parseFloat(r[tempField]))
    },
    "red"
  );

  charts.pressure = createLineChart(
    document.getElementById("pressureChart"),
    "Pressure (hPa)",
    {
      labels,
      values: rows.map(r => parseFloat(r.pressure_hpa))
    },
    "blue"
  );

  charts.humidity = createLineChart(
    document.getElementById("humidityChart"),
    "Humidity (%)",
    {
      labels,
      values: rows.map(r => parseFloat(r.humidity))
    },
    "green"
  );
}

document.getElementById("dayBtn").onclick  = () => { currentRange = "day";  render(); };
document.getElementById("weekBtn").onclick = () => { currentRange = "week"; render(); };

document.getElementById("cBtn").onclick = () => { currentUnit = "c"; render(); };
document.getElementById("fBtn").onclick = () => { currentUnit = "f"; render(); };

render();

</script>

</body>
</html>
