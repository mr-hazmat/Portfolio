<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Data</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body {
      text-align: center;
    }

    .container {
      max-width: 1400px;
      margin: auto;
      padding: 1.5rem;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 1.5rem 0 2rem;
      flex-wrap: wrap;
    }

    .chart-wrapper {
      width: 66vw;
      height: 380px;
      margin: 2.5rem auto;
    }

    .error {
      color: crimson;
      font-weight: 600;
    }

    .loading {
      color: #555;
      font-style: italic;
    }
    canvas {
      cursor: crosshair;
    }
    .switch {
  position: relative;
  display: inline-block;
  width: 54px;
  height: 28px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  inset: 0;
  background-color: #ccc;
  transition: 0.25s;
  border-radius: 28px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.25s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #2196f3;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

  </style>
</head>

<body>
  <div class="container">
    <h1>Weather Data</h1>
    <p>Local environmental measurements</p>

<div class="controls">
  <span>°C</span>
  <label class="switch">
    <input type="checkbox" id="unitToggle">
    <span class="slider"></span>
  </label>
  <span>°F</span>
</div>

    <p id="status" aria-live="polite"></p>

    <div class="chart-wrapper">
      <canvas id="tempChart" aria-label="Temperature chart"></canvas>
    </div>

    <div class="chart-wrapper">
      <canvas id="pressureChart" aria-label="Pressure chart"></canvas>
    </div>

    <div class="chart-wrapper">
      <canvas id="humidityChart" aria-label="Humidity chart"></canvas>
    </div>
  </div>

<script>
"use strict";

/* -------------------- Configuration -------------------- */

const DATA_URL =
  "https://raw.githubusercontent.com/mr-hazmat/RPi_Compact-Weather-Station/main/docs/data/weather-last-week.csv";

const state = { unit: "C" };
const charts = {};

const el = {
  unitToggle: document.getElementById("unitToggle"),
  status: document.getElementById("status"),
  temp: document.getElementById("tempChart"),
  pressure: document.getElementById("pressureChart"),
  humidity: document.getElementById("humidityChart")
};

/* -------------------- Chart Min/Max Size --------------------*/

function dynamicRange(values, padding = 0.05, hardMin = null, hardMax = null) {
  const min = Math.min(...values);
  const max = Math.max(...values);

  if (!Number.isFinite(min) || !Number.isFinite(max)) return {};

  const span = max - min || 1; // avoid zero-span
  let lo = min - span * padding;
  let hi = max + span * padding;

  if (hardMin !== null) lo = Math.max(lo, hardMin);
  if (hardMax !== null) hi = Math.min(hi, hardMax);

  return {
    min: lo,
    max: hi
  };
}

/* -------------------- Status -------------------- */

function setStatus(msg = "", cls = "") {
  el.status.textContent = msg;
  el.status.className = cls;
}

/* -------------------- CSV Loader -------------------- */

async function loadCSV(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("Failed to fetch weather data");

  const text = await res.text();
  const [header, ...rows] = text.trim().split("\n");
  const keys = header.split(",").map(h => h.trim());

  return rows.map(r =>
    Object.fromEntries(
      r.split(",").map((v, i) => [keys[i], v.trim()])
    )
  );
}

/* -------------------- Cursor Line Plugin -------------------- */

const verticalCursorLine = {
  id: "verticalCursorLine",
  afterDraw(chart) {
    const tooltip = chart.tooltip;
    if (!tooltip || !tooltip.getActiveElements().length) return;

    const ctx = chart.ctx;
    const { top, bottom } = chart.chartArea;
    const x = tooltip.getActiveElements()[0].element.x;

    ctx.save();
    ctx.strokeStyle = "rgba(0,0,0,0.25)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x, top);
    ctx.lineTo(x, bottom);
    ctx.stroke();
    ctx.restore();
  }
};

Chart.register(verticalCursorLine);

/* -------------------- Chart Factory -------------------- */

function createChart(canvas, label, data, color, yOptions = {}) {
  const chart = new Chart(canvas, {
    type: "line",
    data: {
      datasets: [{
        label,
        data,
        parsing: false,
        borderColor: color,
        borderWidth: 2,
        pointRadius: 0
      }]
    },
      options: {
        responsive: true,
        maintainAspectRatio: false,

      interaction: {
        mode: "nearest",
        intersect: false
      },

      scales: {
        x: {
          type: "time",
          time: {
            unit: "day",
            tooltipFormat: "MMM d HH:mm"
          }
        },
        y: yOptions
      },

      plugins: {
        tooltip: {
          enabled: true
        }
      }
    }

  });

  return chart;
}

/* -------------------- Render -------------------- */

function destroyCharts() {
  Object.values(charts).forEach(c => c.destroy());
}

async function render() {
  destroyCharts();
  setStatus("Loading…", "loading");

  try {
    const rows = await loadCSV(DATA_URL);

    const data = rows
      .map(r => {
        const t = new Date(r.timestamp);
        if (Number.isNaN(t)) return null;

        const tempC = parseFloat(r.temp_c);
        const temp = state.unit === "C"
          ? tempC
          : tempC * 9 / 5 + 32;

        const pressure = parseFloat(r.pressure_hpa);
        const humidity = parseFloat(r.humidity);

        if (![temp, pressure, humidity].every(Number.isFinite)) return null;

        return { t, temp, pressure, humidity };
      })
      .filter(Boolean)
      .sort((a, b) => a.t - b.t);

    const tempValues = data.map(d => d.temp);

    charts.temp = createChart(
      el.temp,
      `Temperature (°${state.unit})`,
      data.map(d => ({ x: d.t, y: d.temp })),
      "crimson",
      dynamicRange(tempValues, 0.1)	
    );

    charts.pressure = createChart(
      el.pressure,
      "Pressure (hPa)",
      data.map(d => ({ x: d.t, y: d.pressure })),
      "royalblue",
      { min: 960, max: 1000,
        ticks: { stepSize: 5 }
      }
    );

    charts.humidity = createChart(
      el.humidity,
      "Humidity (%)",
      data.map(d => ({ x: d.t, y: d.humidity })),
      "seagreen",
      { min: 0, max: 100,
	ticks: { stepSize: 10 }
      }
    );

    setStatus();
  } catch (err) {
    setStatus(err.message, "error");
  }
}

/* -------------------- Events -------------------- */

el.unitToggle.addEventListener("change", e => {
  state.unit = e.target.checked ? "F" : "C";
  render();
});
el.unitToggle.checked = state.unit === "F";
render();
</script>

</body>
</html>
