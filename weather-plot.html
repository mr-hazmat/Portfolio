<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Data</title>

  <!-- Existing site styling -->
  <link rel="stylesheet" href="style.css">

  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    body {
      text-align: center;
    }

    .container {
      max-width: 1400px;
      margin: auto;
      padding: 1.5rem;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 1.5rem 0 2rem;
      flex-wrap: wrap;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 500;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #4caf50;
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    /* ✅ Correct Chart.js sizing */
    .chart-wrapper {
      width: 66vw;
      height: 380px;
      margin: 2.5rem auto;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Weather Data</h1>
  <p>Local environmental measurements</p>

  <div class="controls">
    <div class="toggle-group">
      <span>Day</span>
      <label class="switch">
        <input type="checkbox" id="rangeToggle">
        <span class="slider"></span>
      </label>
      <span>Week</span>
    </div>

    <div class="toggle-group">
      <span>°C</span>
      <label class="switch">
        <input type="checkbox" id="unitToggle">
        <span class="slider"></span>
      </label>
      <span>°F</span>
    </div>
  </div>

  <div class="chart-wrapper">
    <canvas id="tempChart"></canvas>
  </div>

  <div class="chart-wrapper">
    <canvas id="pressureChart"></canvas>
  </div>

  <div class="chart-wrapper">
    <canvas id="humidityChart"></canvas>
  </div>
</div>

<script>
/* ============================
   CONFIG
   ============================ */

const DATA_URLS = {
  day:  "https://raw.githubusercontent.com/mr-hazmat/RPi_Compact-Weather-Station/main/docs/data/weather-last-day.csv",
  week: "https://raw.githubusercontent.com/mr-hazmat/RPi_Compact-Weather-Station/main/docs/data/weather-last-week.csv"
};

let currentRange = "day";
let currentUnit  = "c";
let charts = {};

/* ============================
   CSV PARSER
   ============================ */

async function loadCSV(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("CSV load failed");

  const text = await res.text();
  const lines = text.trim().split("\n");
  const headers = lines.shift().split(",");

  return lines.map(line => {
    const values = line.split(",");
    return Object.fromEntries(headers.map((h, i) => [h, values[i]]));
  });
}

/* ============================
   CHART HELPER
   ============================ */

function makeChart(ctx, label, points, color, yOptions = {}) {
  return new Chart(ctx, {
    type: "line",
    data: {
      datasets: [{
        label,
        data: points,
        borderColor: color,
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.25
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          type: "time",
          time: {
            unit: currentRange === "day" ? "hour" : "day"
          },
          ticks: {
            autoSkip: true,
            maxRotation: 0
          }
        },
        y: yOptions
      }
    }
  });
}

function clearCharts() {
  Object.values(charts).forEach(c => c.destroy());
  charts = {};
}

/* ============================
   MAIN RENDER
   ============================ */

async function render() {
  clearCharts();

  const rows = await loadCSV(DATA_URLS[currentRange]);

  const tempKey   = currentUnit === "c" ? "temp_c" : "temp_f";
  const tempLabel = currentUnit === "c" ? "Temperature (°C)" : "Temperature (°F)";

  const clean = rows
    .map(r => {
      const t = new Date(r.timestamp);
      const temp = parseFloat(r[tempKey]);
      const pressure = parseFloat(r.pressure_hpa);
      const humidity = parseFloat(r.humidity);

      if (
        Number.isNaN(t.getTime()) ||
        Number.isNaN(temp) ||
        Number.isNaN(pressure) ||
        Number.isNaN(humidity)
      ) {
        return null;
      }

      return { t, temp, pressure, humidity };
    })
    .filter(Boolean);

  if (clean.length === 0) {
    console.error("No valid data points to plot");
    return;
  }

  charts.temp = makeChart(
    tempChart,
    tempLabel,
    clean.map(r => ({ x: r.t, y: r.temp })),
    "crimson"
  );

  charts.pressure = makeChart(
    pressureChart,
    "Pressure (hPa)",
    clean.map(r => ({ x: r.t, y: r.pressure })),
    "royalblue"
  );

  charts.humidity = makeChart(
    humidityChart,
    "Humidity (%)",
    clean.map(r => ({ x: r.t, y: r.humidity })),
    "seagreen",
    {
      min: 0,
      max: 100,
      ticks: { callback: v => v + "%" }
    }
  );
}

/* ============================
   TOGGLES
   ============================ */

rangeToggle.addEventListener("change", e => {
  currentRange = e.target.checked ? "week" : "day";
  render();
});

unitToggle.addEventListener("change", e => {
  currentUnit = e.target.checked ? "f" : "c";
  render();
});

/* ============================
   INIT
   ============================ */

render();
</script>

</body>
</html>
