<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compact Weather Station</title>
<link rel="stylesheet" href="https://mr-hazmat.github.io/Portfolio/style.css">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<h1>Compact Weather Station</h1>
<div id="plot" style="width: 100%; height: 600px;"></div>

<script>
// Compute ISO week number (matches Python isocalendar()[1])
function getISOWeek(date) {
    const target = new Date(date.valueOf());
    const dayNr = (date.getDay() + 6) % 7; // Mon=0..Sun=6
    target.setDate(target.getDate() - dayNr + 3);
    const firstThursday = new Date(target.getFullYear(),0,4);
    const diff = target - firstThursday;
    return 1 + Math.round(diff / (7*24*60*60*1000));
}

// Pad numbers
function pad(n) { return n < 10 ? "0" + n : n; }

// Today
const today = new Date();
const year = today.getFullYear();
const monthNum = pad(today.getMonth() + 1);
const monthName = today.toLocaleString('en-US', { month: 'long' });
const weekNum = pad(getISOWeek(today));
const day = pad(today.getDate());

// Construct GitHub raw URL
const logUrl = `https://raw.githubusercontent.com/mr-hazmat/RPi_Compact-Weather-Station/main/logs/${year}/${monthNum}_${monthName}/Week_${weekNum}/${year}-${monthNum}-${day}.log`;

console.log("Fetching log from:", logUrl);

Plotly.d3.text(logUrl, function(err, text) {
    if (err) {
        console.error("Failed to load .log:", err);
        document.getElementById('plot').innerText = "Failed to load weather data.";
        return;
    }

    const rows = text.trim().split("\n").map(line => {
        const [timestamp, values] = line.split(" ", 2);
        if (!values) return null;
        const [temp_c, temp_f, pressure, humidity] = values.split(",").map(parseFloat);
        return { timestamp, temp_c, temp_f, pressure, humidity };
    }).filter(r => r !== null);

    if (rows.length === 0) {
        document.getElementById('plot').innerText = "No valid data in .log file.";
        return;
    }

    const data = [
        { x: rows.map(r => r.timestamp), y: rows.map(r => r.temp_c), type: 'scatter', mode: 'lines+markers', name: 'Temp (°C)' },
        { x: rows.map(r => r.timestamp), y: rows.map(r => r.temp_f), type: 'scatter', mode: 'lines+markers', name: 'Temp (°F)' },
        { x: rows.map(r => r.timestamp), y: rows.map(r => r.pressure), type: 'scatter', mode: 'lines+markers', name: 'Pressure (hPa)' },
        { x: rows.map(r => r.timestamp), y: rows.map(r => r.humidity), type: 'scatter', mode: 'lines+markers', name: 'Humidity (%)' }
    ];

    const layout = {
        title: 'Weather Station Data',
        xaxis: { title: 'Timestamp', tickangle: -45 },
        yaxis: { title: 'Values' },
        legend: { orientation: 'h', y: -0.2 },
        margin: { t: 50, b: 50, l: 50, r: 50 }
    };

    Plotly.newPlot('plot', data, layout, { responsive: true });
});
</script>
</body>
</html>
